<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication as a Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f1f3f5;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            font-size: 18px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            outline: none;
        }

        .form-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #f03e3e;
        }

        .form-group input.success {
            border-color: #51cf66;
        }

        .error-message {
            color: #f03e3e;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            color: #51cf66;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: #ffe3e3;
            color: #c92a2a;
            border: 1px solid #ffc9c9;
        }

        .alert-success {
            background: #d3f9d8;
            color: #2b8a3e;
            border: 1px solid #b2f2bb;
        }

        .alert-info {
            background: #d0ebff;
            color: #1864ab;
            border: 1px solid #a5d8ff;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .grid-cell {
            aspect-ratio: 1;
            border: 3px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            font-size: 24px;
        }

        .grid-cell:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .grid-cell.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pattern-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e7f5ff;
            border-radius: 10px;
            color: #1864ab;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard {
            display: none;
        }

        .dashboard.show {
            display: block;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h2 {
            color: #495057;
            margin-bottom: 10px;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info p {
            margin-bottom: 10px;
            color: #495057;
        }

        .user-info strong {
            color: #212529;
        }

        .password-requirements {
            font-size: 12px;
            color: #868e96;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .password-requirements ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .password-requirements li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">üîê</div>
            <h1>Authentication as a Service</h1>
            <p>Secure Multi-Factor Authentication System</p>
        </div>

        <div class="content">
            <!-- Auth Section (Login/Register) -->
            <div id="authSection">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('login')">
                        üîë Login
                    </button>
                    <button class="tab-btn" onclick="switchTab('register')">
                        üìù Register
                    </button>
                </div>

                <div class="alert alert-error" id="alertBox"></div>
                <div class="alert alert-success" id="successBox"></div>

                <!-- Login Tab -->
                <div id="loginTab" class="tab-content active">
                    <div class="form-group">
                        <label>üë§ Username</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üë§</span>
                            <input type="text" id="loginUsername" placeholder="Enter your username">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üîí Password</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üîí</span>
                            <input type="password" id="loginPassword" placeholder="Enter your password">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="login()">
                        üöÄ Login
                    </button>
                </div>

                <!-- Register Tab -->
                <div id="registerTab" class="tab-content">
                    <div class="form-group">
                        <label>üìß Email</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üìß</span>
                            <input type="email" id="registerEmail" placeholder="your@email.com" 
                                   onblur="checkAvailability('email')">
                        </div>
                        <div class="error-message" id="emailError"></div>
                        <div class="success-message" id="emailSuccess"></div>
                    </div>

                    <div class="form-group">
                        <label>üë§ Username</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üë§</span>
                            <input type="text" id="registerUsername" placeholder="Choose a username"
                                   onblur="checkAvailability('username')">
                        </div>
                        <div class="error-message" id="usernameError"></div>
                        <div class="success-message" id="usernameSuccess"></div>
                    </div>

                    <div class="form-group">
                        <label>üîí Password</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üîí</span>
                            <input type="password" id="registerPassword" placeholder="Create a strong password">
                        </div>
                        <div class="password-requirements">
                            <strong>Password must contain:</strong>
                            <ul>
                                <li>At least 10 characters</li>
                                <li>Uppercase and lowercase letters</li>
                                <li>At least one number</li>
                                <li>At least one special character (!@#$%^&*)</li>
                            </ul>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="register()">
                        ‚ú® Create Account
                    </button>
                </div>
            </div>

            <!-- Pattern Setup Section -->
            <div id="patternSetupSection" style="display: none;">
                <div class="pattern-info">
                    <strong>üé® Setup Your Pattern</strong><br>
                    Select at least 3 grid positions as your authentication pattern
                </div>

                <div class="grid-container" id="setupGrid"></div>

                <div style="text-align: center; margin-top: 10px; color: #667eea; font-weight: 600;">
                    Selected: <span id="selectedCount">0</span> positions
                </div>

                <button class="btn btn-primary" onclick="savePattern()" id="savePatternBtn" disabled>
                    üíæ Save Pattern
                </button>
            </div>

            <!-- Pattern Verification Section -->
            <div id="patternVerifySection" style="display: none;">
                <div class="pattern-info">
                    <strong>üîç Verify Your Pattern</strong><br>
                    Select the same positions you chose during setup
                </div>

                <div class="grid-container" id="verifyGrid"></div>

                <div style="text-align: center; margin-top: 10px; color: #667eea; font-weight: 600;">
                    Selected: <span id="verifyCount">0</span> positions
                </div>

                <button class="btn btn-primary" onclick="verifyPattern()">
                    ‚úÖ Verify Pattern
                </button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="dashboard">
                <div class="dashboard-header">
                    <h2>üéâ Welcome!</h2>
                </div>

                <div class="user-info">
                    <p><strong>Username:</strong> <span id="dashUsername"></span></p>
                    <p><strong>Status:</strong> <span style="color: #51cf66;">‚úì Authenticated</span></p>
                </div>

                <button class="btn btn-primary" onclick="logout()">
                    üö™ Logout
                </button>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>
        </div>
    </div>

    <script>
        let currentUsername = '';
        let currentSessionId = '';
        let currentChallengeToken = '';
        let selectedPositions = [];

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
            
            hideAlert();
        }

        function showAlert(message, type = 'error') {
            const alertBox = type === 'error' ? document.getElementById('alertBox') : document.getElementById('successBox');
            const otherBox = type === 'error' ? document.getElementById('successBox') : document.getElementById('alertBox');
            
            otherBox.classList.remove('show');
            alertBox.textContent = message;
            alertBox.classList.add('show');
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.remove('show');
            document.getElementById('successBox').classList.remove('show');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        async function checkAvailability(field) {
            const input = document.getElementById(`register${field.charAt(0).toUpperCase() + field.slice(1)}`);
            const value = input.value.trim();
            
            if (!value) return;

            try {
                const response = await fetch('/api/check-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });

                const data = await response.json();
                const errorEl = document.getElementById(`${field}Error`);
                const successEl = document.getElementById(`${field}Success`);

                if (field === 'email') {
                    if (!data.email_valid) {
                        input.classList.add('error');
                        input.classList.remove('success');
                        errorEl.textContent = data.email_message;
                        errorEl.classList.add('show');
                        successEl.classList.remove('show');
                    } else if (!data.email_available) {
                        input.classList.add('error');
                        input.classList.remove('success');
                        errorEl.textContent = data.email_message;
                        errorEl.classList.add('show');
                        successEl.classList.remove('show');
                    } else {
                        input.classList.remove('error');
                        input.classList.add('success');
                        errorEl.classList.remove('show');
                        successEl.textContent = '‚úì Email is available';
                        successEl.classList.add('show');
                    }
                } else if (field === 'username') {
                    if (!data.username_available) {
                        input.classList.add('error');
                        input.classList.remove('success');
                        errorEl.textContent = data.username_message;
                        errorEl.classList.add('show');
                        successEl.classList.remove('show');
                    } else {
                        input.classList.remove('error');
                        input.classList.add('success');
                        errorEl.classList.remove('show');
                        successEl.textContent = '‚úì Username is available';
                        successEl.classList.add('show');
                    }
                }
            } catch (error) {
                console.error('Availability check failed:', error);
            }
        }

        async function register() {
            hideAlert();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !username || !password) {
                showAlert('Please fill in all fields');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUsername = data.username;
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('patternSetupSection').style.display = 'block';
                        initializeSetupGrid();
                    }, 1500);
                } else {
                    showAlert(data.error || 'Registration failed');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function login() {
            hideAlert();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAlert('Please enter username and password');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUsername = username;
                    currentSessionId = data.session_id;
                    
                    // Initialize pattern challenge
                    await initializePatternChallenge();
                } else {
                    showAlert(data.error || 'Login failed');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function initializeSetupGrid() {
            const grid = document.getElementById('setupGrid');
            grid.innerHTML = '';
            selectedPositions = [];

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = '‚óªÔ∏è';
                    cell.onclick = () => toggleCell(cell, row, col, 'setup');
                    grid.appendChild(cell);
                }
            }
            updateSelectedCount('setup');
        }

        function toggleCell(cell, row, col, mode) {
            const posKey = `${row},${col}`;
            const index = selectedPositions.findIndex(p => p[0] === row && p[1] === col);

            if (index > -1) {
                selectedPositions.splice(index, 1);
                cell.classList.remove('selected');
                cell.textContent = '‚óªÔ∏è';
            } else {
                selectedPositions.push([row, col]);
                cell.classList.add('selected');
                cell.textContent = '‚úì';
            }

            updateSelectedCount(mode);
        }

        function updateSelectedCount(mode) {
            const countEl = document.getElementById(mode === 'setup' ? 'selectedCount' : 'verifyCount');
            countEl.textContent = selectedPositions.length;

            if (mode === 'setup') {
                document.getElementById('savePatternBtn').disabled = selectedPositions.length < 3;
            }
        }

        async function savePattern() {
            if (selectedPositions.length < 3) {
                showAlert('Please select at least 3 positions');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/pattern/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        pattern: selectedPositions
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Pattern saved successfully! You can now login.', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showAlert(data.error || 'Failed to save pattern');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function initializePatternChallenge() {
            showLoading(true);

            try {
                const response = await fetch('/api/pattern/challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentChallengeToken = data.challenge_token;
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('patternVerifySection').style.display = 'block';
                    renderVerifyGrid(data.grid);
                } else {
                    showAlert(data.error || 'Failed to initialize challenge');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function renderVerifyGrid(grid) {
            const gridEl = document.getElementById('verifyGrid');
            gridEl.innerHTML = '';
            selectedPositions = [];

            grid.forEach(row => {
                row.forEach(cell => {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'grid-cell';
                    cellEl.textContent = cell.image;
                    cellEl.onclick = () => toggleCell(cellEl, cell.position[0], cell.position[1], 'verify');
                    gridEl.appendChild(cellEl);
                });
            });
            updateSelectedCount('verify');
        }

        async function verifyPattern() {
            if (selectedPositions.length === 0) {
                showAlert('Please select your pattern positions');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/pattern/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        session_id: currentSessionId,
                        challenge_token: currentChallengeToken,
                        selected_positions: selectedPositions
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('patternVerifySection').style.display = 'none';
                    document.getElementById('dashboardSection').classList.add('show');
                    document.getElementById('dashUsername').textContent = currentUsername;
                } else {
                    showAlert(data.message || 'Pattern verification failed');
                    if (data.attempts_remaining === 0) {
                        setTimeout(() => location.reload(), 2000);
                    }
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function logout() {
            if (currentSessionId) {
                await fetch(`/api/session/${currentSessionId}`, { method: 'DELETE' });
            }
            location.reload();
        }
    </script>
</body>
</html>